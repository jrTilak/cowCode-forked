<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>cowCode Dashboard</title>
  <style>
    :root {
      --bg: #0f0f12;
      --card: #1a1a1f;
      --text: #e4e4e7;
      --muted: #71717a;
      --green: #22c55e;
      --red: #ef4444;
      --accent: #a78bfa;
      --border: #27272a;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', monospace;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1.5rem 2rem;
      line-height: 1.5;
    }
    h1 { font-size: 1.25rem; font-weight: 600; margin: 0 0 1.5rem 0; color: var(--accent); }
    nav {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.75rem;
    }
    nav a {
      color: var(--muted);
      text-decoration: none;
      padding: 0.35rem 0.75rem;
      border-radius: 4px;
    }
    nav a:hover { color: var(--text); background: var(--card); }
    nav a.active { color: var(--accent); }
    .page { display: none; }
    .page.active { display: block; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.5rem;
      animation: pulse 2s infinite;
    }
    .status-dot.running { background: var(--green); }
    .status-dot.stopped { background: var(--red); }
    @keyframes pulse { 0%,100%{ opacity:1 } 50%{ opacity:0.6 } }
    .url-box {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 0.75rem;
      word-break: break-all;
    }
    .url-box strong { color: var(--text); }
    .overview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(12rem, 1fr));
      gap: 0.75rem 1.5rem;
      margin-top: 1.25rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }
    .overview-item { display: flex; flex-direction: column; gap: 0.2rem; }
    .overview-label { font-size: 0.8rem; color: var(--muted); }
    .overview-item span:last-child { font-weight: 500; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    th, td { text-align: left; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-weight: 500; }
    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
    }
    .badge.enabled { background: rgba(34, 197, 94, 0.2); color: var(--green); }
    .badge.disabled { background: rgba(239, 68, 68, 0.2); color: var(--red); }
    .skill-item { border-bottom: 1px solid var(--border); }
    .skill-item:last-child { border-bottom: none; }
    .skill-row { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; }
    .skill-id { font-weight: 500; }
    .skill-meta { font-size: 0.8rem; color: var(--muted); }
    label { display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; }
    input[type="checkbox"] { accent-color: var(--accent); }
    button {
      background: var(--accent);
      color: var(--bg);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 1rem;
    }
    button:hover { filter: brightness(1.1); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .config-json { white-space: pre-wrap; font-size: 0.8rem; overflow-x: auto; }
    .error { color: var(--red); font-size: 0.9rem; }
    .empty { color: var(--muted); font-style: italic; }
    .field { margin-bottom: 1rem; }
    .field label { display: block; color: var(--muted); font-size: 0.8rem; margin-bottom: 0.25rem; }
    .field input[type="text"], .field input[type="number"] {
      width: 100%;
      max-width: 24rem;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.4rem 0.5rem;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.9rem;
    }
    .llm-models-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    .llm-model {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
    }
    .llm-model .field input { max-width: none; }
    .llm-model h3 { margin: 0 0 0.5rem 0; font-size: 0.95rem; color: var(--accent); }
    .form-row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; margin-bottom: 0.5rem; }
    .form-row label { margin-bottom: 0; }
    .read-only-note { font-size: 0.8rem; color: var(--muted); margin-bottom: 0.75rem; }
    .skill-row { cursor: pointer; }
    .skill-row:hover { background: var(--card); }
    .skill-desc { font-size: 0.8rem; color: var(--muted); margin-top: 0.2rem; max-width: 42rem; }
    .skill-doc-inline { display: none; margin: 0 0 1rem 0; padding: 1rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; border-top: none; }
    .skill-doc-inline.open { display: block; }
    .skill-doc-inline h3 { margin: 0 0 0.5rem 0; font-size: 1rem; }
    .skill-doc-inline .skill-doc-textarea { width: 100%; min-height: 16rem; background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 0.75rem; border-radius: 6px; font-family: inherit; font-size: 0.85rem; resize: vertical; }
    code { font-size: 0.85em; color: var(--muted); }
    .groups-layout { display: flex; gap: 1.5rem; flex-wrap: wrap; }
    .groups-sidebar { min-width: 14rem; max-width: 18rem; }
    .groups-ul { list-style: none; margin: 0; padding: 0; }
    .groups-ul li { margin: 0.25rem 0; }
    .groups-ul a, .groups-ul button.link { background: none; border: none; font: inherit; color: var(--accent); cursor: pointer; padding: 0.35rem 0; text-align: left; width: 100%; }
    .groups-ul a:hover, .groups-ul button.link:hover { text-decoration: underline; }
    .groups-ul li.selected a, .groups-ul li.selected button.link { color: var(--text); font-weight: 500; }
    .groups-main { flex: 1; min-width: 20rem; }
    .groups-detail-body .detail-row { margin-bottom: 0.75rem; }
    .groups-detail-body .detail-label { font-size: 0.8rem; color: var(--muted); }
    .groups-detail-body .detail-value { font-size: 0.9rem; word-break: break-all; }
    .groups-detail-body .log-files { font-size: 0.85rem; max-height: 12rem; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>cowCode Dashboard</h1>
  <nav>
    <a href="#status" data-page="status" class="active">Status</a>
    <a href="#crons" data-page="crons">Crons</a>
    <a href="#skills" data-page="skills">Skills</a>
    <a href="#groups" data-page="groups">Groups</a>
    <a href="#llm" data-page="llm">LLM</a>
    <a href="#config" data-page="config">Config</a>
  </nav>

  <div id="page-status" class="page active">
    <div class="card">
      <div>
        <span id="status-dot" class="status-dot stopped"></span>
        <span id="status-text">Checking…</span>
      </div>
      <div class="url-box">
        Dashboard URL (for future POST/API): <strong id="dashboard-url">—</strong>
      </div>
      <div class="overview-grid">
        <div class="overview-item"><span class="overview-label">Daemon uptime</span><span id="overview-uptime">—</span></div>
        <div class="overview-item"><span class="overview-label">Crons activated</span><span id="overview-crons">—</span></div>
        <div class="overview-item"><span class="overview-label">Skills activated</span><span id="overview-skills">—</span></div>
        <div class="overview-item"><span class="overview-label">Group skills</span><span id="overview-group-skills">—</span></div>
        <div class="overview-item"><span class="overview-label">Priority model</span><span id="overview-model">—</span></div>
        <div class="overview-item"><span class="overview-label">Time zone</span><span id="overview-timezone">—</span></div>
        <div class="overview-item"><span class="overview-label">Time format</span><span id="overview-time-format">—</span></div>
      </div>
    </div>
  </div>

  <div id="page-crons" class="page">
    <div class="card">
      <h2 style="margin:0 0 0.75rem 0; font-size:1rem;">Scheduled crons</h2>
      <div id="crons-list"></div>
    </div>
  </div>

  <div id="page-skills" class="page">
    <div class="card">
      <h2 style="margin:0 0 0.75rem 0; font-size:1rem;">Skills (main / one-on-one)</h2>
      <p class="skill-meta" style="margin:0 0 0.75rem 0;">Enable or disable skills for private chat; click a skill to view or edit its doc (SKILL.md).</p>
      <div id="skills-list"></div>
      <button id="skills-save" style="display:none;">Save enabled/disabled</button>
    </div>
  </div>

  <div id="page-groups" class="page">
    <div class="groups-layout">
      <div class="groups-sidebar card">
        <h2 style="margin:0 0 0.75rem 0; font-size:1rem;">Groups</h2>
        <p class="skill-meta" style="margin:0 0 0.5rem 0;">Click a group to edit its skills and LLM. Default settings are used by new groups.</p>
        <ul id="groups-list" class="groups-ul"></ul>
      </div>
      <div class="groups-main">
        <div id="groups-detail-content" class="groups-detail card">
          <h2 style="margin:0 0 0.75rem 0; font-size:1rem;" id="groups-detail-title">Select a group</h2>
          <p class="skill-meta" id="groups-detail-meta" style="margin:0 0 0.75rem 0;"></p>
          <div id="groups-detail-skills" style="display:none;">
            <h3 style="margin:0 0 0.5rem 0; font-size:0.95rem;">Skills</h3>
            <p class="skill-meta" style="margin:0 0 0.5rem 0;">Enable or disable skills; click a skill to view its doc (SKILL.md).</p>
            <div id="group-skills-list"></div>
            <button id="group-skills-save" style="display:none;">Save skills</button>
          </div>
          <div id="groups-detail-llm" style="display:none; margin-top:1.5rem;">
            <h3 style="margin:0 0 0.5rem 0; font-size:0.95rem;">LLM</h3>
            <p class="skill-meta" style="margin:0 0 0.5rem 0;">Max tokens and models for this group. API keys from .env.</p>
            <div class="field" style="margin-top:0.5rem;">
              <label>Max tokens</label>
              <input type="number" id="group-llm-max-tokens" min="256" max="128000" step="256" value="2048">
            </div>
            <div id="group-llm-models" class="llm-models-grid"></div>
            <button id="group-llm-save">Save LLM</button>
            <span id="group-llm-saved" style="margin-left:0.75rem; color: var(--green); font-size:0.85rem; display:none;">Saved.</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="page-llm" class="page">
    <div class="card">
      <h2 style="margin:0 0 0.75rem 0; font-size:1rem;">LLM</h2>
      <p class="skill-meta" style="margin:0 0 1rem 0;">Edit below and save. API keys are stored in .env; use the env var name here (e.g. LLM_1_API_KEY).</p>
      <div class="field">
        <label>Max tokens</label>
        <input type="number" id="llm-max-tokens" min="256" max="128000" step="256" value="2048">
      </div>
      <div id="llm-models" class="llm-models-grid"></div>
      <button id="llm-save">Save LLM settings</button>
      <span id="llm-saved-msg" style="margin-left:0.75rem; color: var(--green); font-size:0.85rem; display:none;">Saved.</span>
    </div>
  </div>

  <div id="page-config" class="page">
    <div class="card">
      <h2 style="margin:0 0 0.75rem 0; font-size:1rem;">Config</h2>
      <p class="read-only-note">Final configuration (read-only). Written to config.json.</p>
      <pre id="full-config" class="config-json"></pre>
    </div>
  </div>

  <script>
    const API = '';
    function setPage(name) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
      const page = document.getElementById('page-' + name);
      const link = document.querySelector('nav a[data-page="' + name + '"]');
      if (page) page.classList.add('active');
      if (link) link.classList.add('active');
      if (name === 'crons') fetchCrons();
      if (name === 'skills') fetchSkills();
      if (name === 'groups') { fetchGroups(); }
      if (name === 'llm') renderLlmForm();
      if (name === 'config') fetchConfig();
    }
    document.querySelectorAll('nav a[data-page]').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        setPage(a.dataset.page);
      });
    });
    window.addEventListener('hashchange', () => {
      const name = (location.hash || '#status').slice(1) || 'status';
      setPage(name);
    });

    async function fetchStatus() {
      const dot = document.getElementById('status-dot');
      const text = document.getElementById('status-text');
      const urlEl = document.getElementById('dashboard-url');
      try {
        const statusRes = await fetch(API + '/api/status');
        const statusData = await statusRes.json();
        if (statusData.dashboardUrl) urlEl.textContent = statusData.dashboardUrl;
        if (statusData.daemonRunning) {
          dot.className = 'status-dot running';
          text.textContent = 'Daemon is running';
        } else {
          dot.className = 'status-dot stopped';
          text.textContent = 'Daemon is not running';
        }
      } catch (e) {
        dot.className = 'status-dot stopped';
        text.textContent = 'Daemon is not running';
        urlEl.textContent = '—';
      }
      function formatUptime(sec) {
        if (sec == null || typeof sec !== 'number' || sec < 0) return '—';
        const d = Math.floor(sec / 86400);
        const h = Math.floor((sec % 86400) / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        const parts = [];
        if (d > 0) parts.push(d + 'd');
        if (h > 0) parts.push(h + 'h');
        if (m > 0) parts.push(m + 'm');
        if (s > 0 || parts.length === 0) parts.push(s + 's');
        return parts.join(' ');
      }
      function setOverview(d) {
        document.getElementById('overview-uptime').textContent = d.daemonRunning && d.daemonUptimeSeconds != null ? formatUptime(d.daemonUptimeSeconds) : '—';
        document.getElementById('overview-crons').textContent = typeof d.cronCount === 'number' ? d.cronCount : '—';
        document.getElementById('overview-skills').textContent = typeof d.skillsEnabledCount === 'number' ? d.skillsEnabledCount : '—';
        document.getElementById('overview-group-skills').textContent = typeof d.groupSkillsEnabledCount === 'number' ? d.groupSkillsEnabledCount : '—';
        document.getElementById('overview-model').textContent = d.priorityModelLabel || '—';
        document.getElementById('overview-timezone').textContent = d.timezone || '—';
        document.getElementById('overview-time-format').textContent = d.timeFormat === '12' ? '12-hour' : d.timeFormat === '24' ? '24-hour' : (d.timeFormat || '—');
      }
      try {
        const overviewRes = await fetch(API + '/api/overview');
        if (overviewRes.ok) {
          const d = await overviewRes.json();
          setOverview(d);
          return;
        }
      } catch (_) {}
      try {
        const [cronsRes, skillsRes, groupSkillsRes, configRes] = await Promise.all([
          fetch(API + '/api/crons'),
          fetch(API + '/api/skills'),
          fetch(API + '/api/group/skills'),
          fetch(API + '/api/config')
        ]);
        const crons = cronsRes.ok ? await cronsRes.json() : {};
        const skills = skillsRes.ok ? await skillsRes.json() : {};
        const groupSkills = groupSkillsRes.ok ? await groupSkillsRes.json() : {};
        const config = configRes.ok ? await configRes.json() : {};
        const jobs = crons.jobs || [];
        const cronCount = jobs.filter(function (j) { return j.enabled !== false; }).length;
        const skillsEnabled = skills.enabled || [];
        const groupSkillsEnabled = groupSkills.enabled || [];
        const models = config.llm && Array.isArray(config.llm.models) ? config.llm.models : [];
        const priorityEntry = models.find(function (m) { return m.priority === true || m.priority === 1 || String(m.priority).toLowerCase() === 'true'; }) || models[0];
        const priorityModelLabel = priorityEntry ? (priorityEntry.model || priorityEntry.provider || '—') : '—';
        const def = config.agents && config.agents.defaults ? config.agents.defaults : {};
        const tz = def.userTimezone && String(def.userTimezone).trim() && String(def.userTimezone).toLowerCase() !== 'auto' ? def.userTimezone : (typeof Intl !== 'undefined' && Intl.DateTimeFormat && Intl.DateTimeFormat().resolvedOptions ? Intl.DateTimeFormat().resolvedOptions().timeZone : 'UTC');
        const fmt = def.timeFormat === '12' || def.timeFormat === '24' ? def.timeFormat : null;
        setOverview({
          daemonRunning: false,
          daemonUptimeSeconds: null,
          cronCount: cronCount,
          skillsEnabledCount: skillsEnabled.length,
          groupSkillsEnabledCount: groupSkillsEnabled.length,
          priorityModelLabel: priorityModelLabel,
          timezone: tz,
          timeFormat: fmt || '—'
        });
      } catch (_) {}
    }

    async function fetchCrons() {
      const r = await fetch(API + '/api/crons');
      const d = await r.json();
      const el = document.getElementById('crons-list');
      const jobs = d.jobs || [];
      if (jobs.length === 0) {
        el.innerHTML = '<p class="empty">No scheduled crons.</p>';
        return;
      }
      el.innerHTML = '<table><thead><tr><th>Name</th><th>Enabled</th><th>Schedule</th><th>Message</th></tr></thead><tbody>' +
        jobs.map(j => {
          const s = j.schedule || {};
          const sched = s.kind === 'cron' ? (s.expr || '') : (s.at || '');
          return '<tr><td>' + escapeHtml(j.name || j.id) + '</td><td><span class="badge ' + (j.enabled ? 'enabled' : 'disabled') + '">' + (j.enabled ? 'On' : 'Off') + '</span></td><td>' + escapeHtml(sched) + '</td><td>' + escapeHtml((j.message || '').slice(0, 60)) + (j.message && j.message.length > 60 ? '…' : '') + '</td></tr>';
        }).join('') + '</tbody></table>';
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    let skillsDirty = false;
    let currentEnabled = [];

    let currentSkillId = null;

    async function fetchSkills() {
      const r = await fetch(API + '/api/skills');
      const d = await r.json();
      currentEnabled = d.enabled || [];
      const list = d.skills || [];
      const el = document.getElementById('skills-list');
      el.innerHTML = list.map(s => {
        const checked = currentEnabled.includes(s.id) ? ' checked' : '';
        const desc = (s.description || '').trim();
        const descHtml = desc ? '<div class="skill-desc">' + escapeHtml(desc) + '</div>' : '';
        return '<div class="skill-item"><div class="skill-row" data-id="' + escapeHtml(s.id) + '"><div><span class="skill-id">' + escapeHtml(s.id) + '</span>' + descHtml + '</div><label onclick="event.stopPropagation()"><input type="checkbox" data-id="' + escapeHtml(s.id) + '"' + checked + '> Enabled</label></div>' +
          '<div class="skill-doc-inline" data-id="' + escapeHtml(s.id) + '"><h3>Doc: ' + escapeHtml(s.id) + '</h3><p class="skill-meta skill-doc-desc" style="margin:0 0 0.5rem 0;"></p><textarea class="skill-doc-textarea" spellcheck="false"></textarea><div style="margin-top:0.75rem;"><button class="skill-doc-save-btn">Save doc</button><span class="skill-doc-saved" style="margin-left:0.75rem; color: var(--green); font-size:0.85rem; display:none;">Saved.</span></div></div></div>';
      }).join('');
      el.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', () => { skillsDirty = true; document.getElementById('skills-save').style.display = 'block'; });
      });
      el.querySelectorAll('.skill-row').forEach(row => {
        row.addEventListener('click', (e) => { if (!e.target.closest('label')) openSkillDoc(row.dataset.id, row.closest('.skill-item')); });
      });
      el.querySelectorAll('.skill-doc-save-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const panel = btn.closest('.skill-doc-inline');
          const id = panel && panel.dataset.id;
          if (!id) return;
          const content = panel.querySelector('.skill-doc-textarea').value;
          const r = await fetch(API + '/api/skills/' + encodeURIComponent(id) + '/doc', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content }) });
          if (r.ok) {
            const savedEl = panel.querySelector('.skill-doc-saved');
            if (savedEl) { savedEl.style.display = 'inline'; setTimeout(() => { savedEl.style.display = 'none'; }, 2000); }
          }
        });
      });
      document.getElementById('skills-save').style.display = 'none';
      skillsDirty = false;
    }

    async function openSkillDoc(id, skillItem) {
      currentSkillId = id;
      const listEl = document.getElementById('skills-list');
      listEl.querySelectorAll('.skill-doc-inline').forEach(p => p.classList.remove('open'));
      const panel = skillItem ? skillItem.querySelector('.skill-doc-inline') : listEl.querySelector('.skill-doc-inline[data-id="' + id + '"]');
      if (!panel) return;
      const r = await fetch(API + '/api/skills/' + encodeURIComponent(id) + '/doc');
      if (!r.ok) return;
      const d = await r.json();
      panel.querySelector('.skill-doc-desc').textContent = d.description || '';
      panel.querySelector('.skill-doc-textarea').value = d.content || '';
      panel.classList.add('open');
    }

    document.getElementById('skills-save').addEventListener('click', async () => {
      const boxes = document.querySelectorAll('#skills-list input[type="checkbox"]:checked');
      const enabled = Array.from(boxes).map(b => b.dataset.id);
      const r = await fetch(API + '/api/skills', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled }) });
      if (r.ok) { skillsDirty = false; document.getElementById('skills-save').style.display = 'none'; }
    });

    let groupSkillsDirty = false;
    let selectedGroupId = 'default';

    async function fetchGroups() {
      var ul = document.getElementById('groups-list');
      var oldHint = document.getElementById('groups-path-hint');
      if (oldHint) oldHint.remove();
      var r = await fetch(API + '/api/groups');
      var d = await r.json().catch(function () { return {}; });
      var groups = d.groups || [];
      if (d.error) console.error('[groups]', d.error);
      ul.innerHTML =
        '<li class="' + (selectedGroupId === 'default' ? 'selected' : '') + '"><button type="button" class="link" data-id="default">Default settings</button></li>' +
        groups.map(function (g) {
          return '<li class="' + (selectedGroupId === g.id ? 'selected' : '') + '"><button type="button" class="link" data-id="' + escapeHtml(g.id) + '">' + escapeHtml(g.label) + '</button></li>';
        }).join('');
      if (groups.length === 0 && (d._path || d.error)) {
        var hint = document.createElement('p');
        hint.id = 'groups-path-hint';
        hint.className = 'skill-meta';
        hint.style.marginTop = '0.5rem';
        hint.textContent = d.error ? ('Error: ' + d.error + (d._path ? ' (path: ' + d._path + ')') : '') : ('No groups yet. Server reading: ' + d._path);
        ul.parentNode.insertBefore(hint, ul.nextSibling);
      }
      ul.querySelectorAll('button.link').forEach(function (btn) {
        btn.addEventListener('click', function () { selectGroup(btn.getAttribute('data-id')); });
      });
      selectGroup(selectedGroupId);
    }

    function selectGroup(id) {
      selectedGroupId = id;
      document.querySelectorAll('#groups-list li').forEach(function (li) {
        var btn = li.querySelector('button.link');
        li.classList.toggle('selected', btn && btn.getAttribute('data-id') === id);
      });
      var titleEl = document.getElementById('groups-detail-title');
      var metaEl = document.getElementById('groups-detail-meta');
      var skillsEl = document.getElementById('groups-detail-skills');
      var llmEl = document.getElementById('groups-detail-llm');
      titleEl.textContent = id === 'default' ? 'Default group settings' : ('Group ' + id);
      skillsEl.style.display = 'block';
      llmEl.style.display = 'block';
      loadGroupSkills(id);
      loadGroupConfig(id);
      if (id !== 'default') {
        fetch(API + '/api/groups/' + encodeURIComponent(id))
          .then(function (r) { return r.ok ? r.json() : null; })
          .then(function (d) {
            if (d && d.chatLogPath) metaEl.textContent = 'Chat log: ' + d.chatLogPath;
            else metaEl.textContent = '';
          })
          .catch(function () { metaEl.textContent = ''; });
      } else {
        metaEl.textContent = 'Used as template for new groups. Stored in ~/.cowcode/group/.';
      }
    }

    async function loadGroupSkills(groupId) {
      var r = await fetch(API + '/api/groups/' + encodeURIComponent(groupId) + '/skills');
      var d = await r.json();
      var enabled = d.enabled || [];
      var list = d.skills || [];
      var el = document.getElementById('group-skills-list');
      el.innerHTML = list.map(function (s) {
        var checked = enabled.includes(s.id) ? ' checked' : '';
        var desc = (s.description || '').trim();
        var descHtml = desc ? '<div class="skill-desc">' + escapeHtml(desc) + '</div>' : '';
        return '<div class="skill-item"><div class="skill-row" data-id="' + escapeHtml(s.id) + '"><div><span class="skill-id">' + escapeHtml(s.id) + '</span>' + descHtml + '</div><label onclick="event.stopPropagation()"><input type="checkbox" data-id="' + escapeHtml(s.id) + '"' + checked + '> Enabled</label></div><div class="skill-doc-inline" data-id="' + escapeHtml(s.id) + '"><h3>Doc: ' + escapeHtml(s.id) + '</h3><p class="skill-meta skill-doc-desc" style="margin:0 0 0.5rem 0;"></p><textarea class="skill-doc-textarea" spellcheck="false"></textarea><div style="margin-top:0.75rem;"><button type="button" class="skill-doc-save-btn">Save doc</button><span class="skill-doc-saved" style="margin-left:0.75rem; color: var(--green); font-size:0.85rem; display:none;">Saved.</span></div></div></div>';
      }).join('');
      el.querySelectorAll('input[type="checkbox"]').forEach(function (cb) {
        cb.addEventListener('change', function () { groupSkillsDirty = true; document.getElementById('group-skills-save').style.display = 'block'; });
      });
      el.querySelectorAll('.skill-row').forEach(function (row) {
        row.addEventListener('click', function (e) { if (!e.target.closest('label')) openGroupSkillDoc(row.getAttribute('data-id'), row.closest('.skill-item')); });
      });
      el.querySelectorAll('.skill-doc-save-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var panel = btn.closest('.skill-doc-inline');
          var skillId = panel && panel.getAttribute('data-id');
          if (!skillId) return;
          var content = panel.querySelector('.skill-doc-textarea').value;
          fetch(API + '/api/skills/' + encodeURIComponent(skillId) + '/doc', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: content }) }).then(function (r) {
            if (r.ok) { var saved = panel.querySelector('.skill-doc-saved'); if (saved) { saved.style.display = 'inline'; setTimeout(function () { saved.style.display = 'none'; }, 2000); } }
          });
        });
      });
      document.getElementById('group-skills-save').style.display = 'none';
      groupSkillsDirty = false;
    }

    async function openGroupSkillDoc(id, skillItem) {
      var listEl = document.getElementById('group-skills-list');
      listEl.querySelectorAll('.skill-doc-inline').forEach(function (p) { p.classList.remove('open'); });
      var panel = skillItem ? skillItem.querySelector('.skill-doc-inline') : listEl.querySelector('.skill-doc-inline[data-id="' + id + '"]');
      if (!panel) return;
      var r = await fetch(API + '/api/skills/' + encodeURIComponent(id) + '/doc');
      if (!r.ok) return;
      var d = await r.json();
      panel.querySelector('.skill-doc-desc').textContent = d.description || '';
      panel.querySelector('.skill-doc-textarea').value = d.content || '';
      panel.classList.add('open');
    }

    document.getElementById('group-skills-save').addEventListener('click', async function () {
      var boxes = document.querySelectorAll('#group-skills-list input[type="checkbox"]:checked');
      var enabled = Array.from(boxes).map(function (b) { return b.getAttribute('data-id'); });
      var r = await fetch(API + '/api/groups/' + encodeURIComponent(selectedGroupId) + '/skills', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled: enabled }) });
      if (r.ok) { groupSkillsDirty = false; document.getElementById('group-skills-save').style.display = 'none'; }
    });

    async function loadGroupConfig(groupId) {
      var r = await fetch(API + '/api/groups/' + encodeURIComponent(groupId) + '/config');
      var config = await r.json();
      var llm = config.llm || {};
      var maxTokens = Number(llm.maxTokens) || 2048;
      var models = Array.isArray(llm.models) ? llm.models : [];
      document.getElementById('group-llm-max-tokens').value = maxTokens;
      var container = document.getElementById('group-llm-models');
      container.innerHTML = models.map(function (m, i) {
        var baseUrl = (m.baseUrl || '').trim();
        var apiKey = (m.apiKey || '').trim();
        var priority = m.priority === true || m.priority === 1 || String(m.priority).toLowerCase() === 'true';
        return '<div class="llm-model" data-i="' + i + '"><h3>Model ' + (i + 1) + ': ' + escapeHtml(m.provider || '') + '</h3><div class="form-row"><div class="field"><label>Provider</label><input type="text" data-f="provider" value="' + escapeHtml(m.provider || '') + '"></div></div><div class="form-row"><div class="field"><label>Model name</label><input type="text" data-f="model" value="' + escapeHtml(m.model || '') + '"></div></div><div class="form-row"><div class="field"><label>Base URL (optional)</label><input type="text" data-f="baseUrl" value="' + escapeHtml(baseUrl) + '"></div></div><div class="form-row"><div class="field"><label>API key env var</label><input type="text" data-f="apiKey" value="' + escapeHtml(apiKey) + '"></div></div><div class="form-row"><label><input type="checkbox" data-f="priority" ' + (priority ? 'checked' : '') + '> Priority</label></div></div>';
      }).join('');
      if (models.length === 0) { container.innerHTML = '<p class="empty">No models. Add in main Config or paste JSON.</p>'; }
    }

    document.getElementById('group-llm-save').addEventListener('click', async function () {
      var maxTokens = Number(document.getElementById('group-llm-max-tokens').value) || 2048;
      var cards = document.querySelectorAll('#group-llm-models .llm-model');
      var models = Array.from(cards).map(function (card) {
        var provider = (card.querySelector('[data-f="provider"]').value || '').trim();
        var model = (card.querySelector('[data-f="model"]').value || '').trim();
        var baseUrl = (card.querySelector('[data-f="baseUrl"]').value || '').trim();
        var apiKey = (card.querySelector('[data-f="apiKey"]').value || '').trim();
        var priority = card.querySelector('[data-f="priority"]').checked;
        var o = { provider: provider || 'openai', model: model || 'gpt-4o', apiKey: apiKey || 'LLM_1_API_KEY' };
        if (baseUrl) o.baseUrl = baseUrl;
        if (priority) o.priority = true;
        return o;
      });
      var r = await fetch(API + '/api/groups/' + encodeURIComponent(selectedGroupId) + '/config', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ llm: { maxTokens: maxTokens, models: models } }) });
      if (r.ok) { document.getElementById('group-llm-saved').style.display = 'inline'; setTimeout(function () { document.getElementById('group-llm-saved').style.display = 'none'; }, 2000); }
    });

    async function fetchConfig() {
      const r = await fetch(API + '/api/config');
      const d = await r.json();
      document.getElementById('full-config').textContent = JSON.stringify(d, null, 2);
    }

    async function renderLlmForm() {
      const r = await fetch(API + '/api/config');
      const d = await r.json();
      const llm = d.llm || {};
      const maxTokens = Number(llm.maxTokens) || 2048;
      const models = Array.isArray(llm.models) ? llm.models : [];
      document.getElementById('llm-max-tokens').value = maxTokens;
      const container = document.getElementById('llm-models');
      container.innerHTML = models.map((m, i) => {
        const baseUrl = (m.baseUrl || '').trim();
        const apiKey = (m.apiKey || '').trim();
        const priority = m.priority === true || m.priority === 1 || String(m.priority).toLowerCase() === 'true';
        return '<div class="llm-model" data-i="' + i + '">' +
          '<h3>Model ' + (i + 1) + ': ' + escapeHtml(m.provider || '') + '</h3>' +
          '<div class="form-row"><div class="field"><label>Provider</label><input type="text" data-f="provider" value="' + escapeHtml(m.provider || '') + '" placeholder="openai, lmstudio, anthropic, grok"></div></div>' +
          '<div class="form-row"><div class="field"><label>Model name</label><input type="text" data-f="model" value="' + escapeHtml(m.model || '') + '" placeholder="gpt-4o, local"></div></div>' +
          '<div class="form-row"><div class="field"><label>Base URL (optional, for local)</label><input type="text" data-f="baseUrl" value="' + escapeHtml(baseUrl) + '" placeholder="http://127.0.0.1:1234/v1"></div></div>' +
          '<div class="form-row"><div class="field"><label>API key env var</label><input type="text" data-f="apiKey" value="' + escapeHtml(apiKey) + '" placeholder="LLM_1_API_KEY"></div></div>' +
          '<div class="form-row"><label><input type="checkbox" data-f="priority" ' + (priority ? 'checked' : '') + '> Priority (use first)</label></div>' +
          '</div>';
      }).join('');
      if (models.length === 0) { container.className = ''; container.innerHTML = '<p class="empty">No models in config. Add entries in Config (read-only) or via setup.</p>'; } else { container.className = 'llm-models-grid'; }
    }

    document.getElementById('llm-save').addEventListener('click', async () => {
      const maxTokens = Number(document.getElementById('llm-max-tokens').value) || 2048;
      const modelCards = document.querySelectorAll('#llm-models .llm-model');
      const models = Array.from(modelCards).map(card => {
        const provider = (card.querySelector('[data-f="provider"]').value || '').trim();
        const model = (card.querySelector('[data-f="model"]').value || '').trim();
        const baseUrl = (card.querySelector('[data-f="baseUrl"]').value || '').trim();
        const apiKey = (card.querySelector('[data-f="apiKey"]').value || '').trim();
        const priority = card.querySelector('[data-f="priority"]').checked;
        const o = { provider: provider || 'openai', model: model || 'gpt-4o', apiKey: apiKey || 'LLM_1_API_KEY' };
        if (baseUrl) o.baseUrl = baseUrl;
        if (priority) o.priority = true;
        return o;
      });
      const r = await fetch(API + '/api/config', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ llm: { maxTokens, models } }) });
      if (r.ok) {
        document.getElementById('llm-saved-msg').style.display = 'inline';
        setTimeout(() => { document.getElementById('llm-saved-msg').style.display = 'none'; }, 2000);
      }
    });

    fetchStatus();
    setInterval(fetchStatus, 8000);
    setPage((location.hash || '#status').slice(1) || 'status');
  </script>
</body>
</html>
