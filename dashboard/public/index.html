<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>cowCode Dashboard</title>
  <style>
    :root {
      --bg: #0f0f12;
      --card: #1a1a1f;
      --text: #e4e4e7;
      --muted: #71717a;
      --green: #22c55e;
      --red: #ef4444;
      --accent: #a78bfa;
      --border: #27272a;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', monospace;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1.5rem 2rem;
      line-height: 1.5;
    }
    h1 { font-size: 1.25rem; font-weight: 600; margin: 0 0 1.5rem 0; color: var(--accent); }
    nav {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.75rem;
    }
    nav a {
      color: var(--muted);
      text-decoration: none;
      padding: 0.35rem 0.75rem;
      border-radius: 4px;
    }
    nav a:hover { color: var(--text); background: var(--card); }
    nav a.active { color: var(--accent); }
    .page { display: none; }
    .page.active { display: block; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.5rem;
      animation: pulse 2s infinite;
    }
    .status-dot.running { background: var(--green); }
    .status-dot.stopped { background: var(--red); }
    @keyframes pulse { 0%,100%{ opacity:1 } 50%{ opacity:0.6 } }
    .url-box {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 0.75rem;
      word-break: break-all;
    }
    .url-box strong { color: var(--text); }
    .overview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(12rem, 1fr));
      gap: 0.75rem 1.5rem;
      margin-top: 1.25rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }
    .overview-item { display: flex; flex-direction: column; gap: 0.2rem; }
    .overview-label { font-size: 0.8rem; color: var(--muted); }
    .overview-item span:last-child { font-weight: 500; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    th, td { text-align: left; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-weight: 500; }
    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
    }
    .badge.enabled { background: rgba(34, 197, 94, 0.2); color: var(--green); }
    .badge.disabled { background: rgba(239, 68, 68, 0.2); color: var(--red); }
    .skill-item { border-bottom: 1px solid var(--border); }
    .skill-item:last-child { border-bottom: none; }
    .skill-row { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; }
    .skill-id { font-weight: 500; }
    .skill-meta { font-size: 0.8rem; color: var(--muted); }
    label { display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; }
    input[type="checkbox"] { accent-color: var(--accent); }
    button {
      background: var(--accent);
      color: var(--bg);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 1rem;
    }
    button:hover { filter: brightness(1.1); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .config-json { white-space: pre-wrap; font-size: 0.8rem; overflow-x: auto; }
    .error { color: var(--red); font-size: 0.9rem; }
    .empty { color: var(--muted); font-style: italic; }
    .field { margin-bottom: 1rem; }
    .field label { display: block; color: var(--muted); font-size: 0.8rem; margin-bottom: 0.25rem; }
    .field input[type="text"], .field input[type="number"] {
      width: 100%;
      max-width: 24rem;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.4rem 0.5rem;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.9rem;
    }
    .llm-models-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    .llm-model {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
    }
    .llm-model .field input { max-width: none; }
    .llm-model h3 { margin: 0 0 0.5rem 0; font-size: 0.95rem; color: var(--accent); }
    .form-row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; margin-bottom: 0.5rem; }
    .form-row label { margin-bottom: 0; }
    .read-only-note { font-size: 0.8rem; color: var(--muted); margin-bottom: 0.75rem; }
    .skill-row { cursor: pointer; }
    .skill-row:hover { background: var(--card); }
    .skill-desc { font-size: 0.8rem; color: var(--muted); margin-top: 0.2rem; max-width: 42rem; }
    .skill-doc-inline { display: none; margin: 0 0 1rem 0; padding: 1rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; border-top: none; }
    .skill-doc-inline.open { display: block; }
    .skill-doc-inline h3 { margin: 0 0 0.5rem 0; font-size: 1rem; }
    .skill-doc-inline .skill-doc-textarea { width: 100%; min-height: 16rem; background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 0.75rem; border-radius: 6px; font-family: inherit; font-size: 0.85rem; resize: vertical; }
    code { font-size: 0.85em; color: var(--muted); }
    .groups-layout { display: flex; gap: 1.5rem; flex-wrap: wrap; }
    .groups-sidebar { min-width: 14rem; max-width: 18rem; }
    .groups-ul { list-style: none; margin: 0; padding: 0; }
    .groups-ul li { margin: 0.25rem 0; }
    .groups-ul a, .groups-ul button.link { background: none; border: none; font: inherit; color: var(--accent); cursor: pointer; padding: 0.35rem 0; text-align: left; width: 100%; }
    .groups-ul a:hover, .groups-ul button.link:hover { text-decoration: underline; }
    .groups-ul li.selected a, .groups-ul li.selected button.link { color: var(--text); font-weight: 500; }
    .groups-main { flex: 1; min-width: 20rem; }
    .groups-detail-body .detail-row { margin-bottom: 0.75rem; }
    .groups-detail-body .detail-label { font-size: 0.8rem; color: var(--muted); }
    .groups-detail-body .detail-value { font-size: 0.9rem; word-break: break-all; }
    .groups-detail-body .log-files { font-size: 0.85rem; max-height: 12rem; overflow-y: auto; }
    .group-sub-nav { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
    .group-sub-nav button { background: none; border: none; font: inherit; color: var(--muted); cursor: pointer; padding: 0.35rem 0.5rem; border-radius: 4px; }
    .group-sub-nav button:hover { color: var(--text); }
    .group-sub-nav button.active { color: var(--accent); font-weight: 500; }
    .group-sub-panel { display: none; }
    .group-sub-panel.active { display: block; }
    .history-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(10rem, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
    .history-stat { font-size: 0.9rem; }
    .history-stat .label { color: var(--muted); }
    .history-log-files { font-size: 0.85rem; max-height: 14rem; overflow-y: auto; }
    .history-log-files table { width: 100%; border-collapse: collapse; }
    .history-log-files th, .history-log-files td { text-align: left; padding: 0.35rem 0.5rem; border-bottom: 1px solid var(--border); }
    .history-log-files th { color: var(--muted); font-weight: 500; }
    .soul-tile-card { margin-top: 0.5rem; }
    .soul-tiles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(10rem, 1fr));
      gap: 0.75rem;
    }
    .soul-tile-link {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      color: var(--text);
      text-decoration: none;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
    }
    .soul-tile-link:hover { color: var(--accent); border-color: var(--accent); }
    .soul-tile-icon { font-size: 1.1rem; color: var(--accent); }
    .soul-tile-title { font-weight: 600; font-size: 1rem; }
    .soul-tile-desc { font-size: 0.8rem; color: var(--muted); }
    #soul-editor-textarea { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.75rem; border-radius: 6px; font-family: inherit; font-size: 0.9rem; resize: vertical; }
    .chat-layout { display: flex; flex-direction: column; height: calc(100vh - 8rem); min-height: 20rem; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
    .chat-msg { max-width: 85%; width: fit-content; padding: 0.6rem 1rem; border-radius: 12px; font-size: 0.95rem; line-height: 1.45; white-space: pre-wrap; word-break: break-word; }
    .chat-msg.user { align-self: flex-end; background: var(--accent); color: var(--bg); }
    .chat-msg.assistant { align-self: flex-start; background: var(--card); border: 1px solid var(--border); }
    .chat-msg.loading { align-self: flex-start; color: var(--muted); font-style: italic; }
    .chat-input-area { display: flex; gap: 0.5rem; padding: 1rem; border-top: 1px solid var(--border); background: var(--card); }
    .chat-input-area textarea { flex: 1; min-height: 2.5rem; max-height: 8rem; padding: 0.5rem 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-family: inherit; font-size: 0.95rem; resize: none; }
    .chat-input-area textarea:focus { outline: none; border-color: var(--accent); }
    .chat-input-area button { flex-shrink: 0; }
  </style>
</head>
<body>
  <h1>cowCode Dashboard</h1>
  <nav>
    <a href="#chat" data-page="chat" class="active">Chat</a>
    <a href="#status" data-page="status">Status</a>
    <a href="#soul" data-page="soul">Soul</a>
    <a href="#crons" data-page="crons">Crons</a>
    <a href="#skills" data-page="skills">Skills</a>
    <a href="#groups" data-page="groups">Groups</a>
    <a href="#llm" data-page="llm">LLM</a>
    <a href="#config" data-page="config">Config</a>
  </nav>

  <div id="page-chat" class="page active">
    <div class="chat-layout card" style="padding:0;">
      <div id="chat-messages" class="chat-messages"></div>
      <div class="chat-input-area">
        <textarea id="chat-input" placeholder="Message the LLM…" rows="1"></textarea>
        <button type="button" id="chat-send">Send</button>
      </div>
    </div>
  </div>

  <div id="page-status" class="page">
    <div class="card">
      <div>
        <span id="status-dot" class="status-dot stopped"></span>
        <span id="status-text">Checking…</span>
      </div>
      <div class="url-box">
        Dashboard URL (for future POST/API): <strong id="dashboard-url">—</strong>
      </div>
      <div class="overview-grid">
        <div class="overview-item"><span class="overview-label">Daemon uptime</span><span id="overview-uptime">—</span></div>
        <div class="overview-item"><span class="overview-label">Crons activated</span><span id="overview-crons">—</span></div>
        <div class="overview-item"><span class="overview-label">Skills activated</span><span id="overview-skills">—</span></div>
        <div class="overview-item"><span class="overview-label">Group skills</span><span id="overview-group-skills">—</span></div>
        <div class="overview-item"><span class="overview-label">Priority model</span><span id="overview-model">—</span></div>
        <div class="overview-item"><span class="overview-label">Time zone</span><span id="overview-timezone">—</span></div>
        <div class="overview-item"><span class="overview-label">Time format</span><span id="overview-time-format">—</span></div>
      </div>
    </div>
    <div class="card soul-tile-card">
      <p class="overview-label" style="margin:0 0 0.5rem 0;">Soul & identity (one-on-one)</p>
      <div class="soul-tiles-grid">
        <a href="#soul/SOUL.md" class="soul-tile-link">
          <span class="soul-tile-icon">◇</span>
          <span class="soul-tile-title">Soul</span>
          <span class="soul-tile-desc">Edit SOUL.md</span>
        </a>
        <a href="#soul/WhoAmI.md" class="soul-tile-link">
          <span class="soul-tile-icon">◇</span>
          <span class="soul-tile-title">Who am I</span>
          <span class="soul-tile-desc">Edit WhoAmI.md</span>
        </a>
        <a href="#soul/MyHuman.md" class="soul-tile-link">
          <span class="soul-tile-icon">◇</span>
          <span class="soul-tile-title">My human</span>
          <span class="soul-tile-desc">Edit MyHuman.md</span>
        </a>
        <a href="#soul/MEMORY.md" class="soul-tile-link">
          <span class="soul-tile-icon">◇</span>
          <span class="soul-tile-title">Memory</span>
          <span class="soul-tile-desc">Edit MEMORY.md</span>
        </a>
      </div>
    </div>
  </div>

  <div id="page-soul" class="page">
    <div class="groups-layout">
      <div class="groups-sidebar card">
        <h2 style="margin:0 0 0.75rem 0; font-size:1rem;">Soul & identity</h2>
        <p class="skill-meta" style="margin:0 0 0.75rem 0;">Click a file to view or edit. Changes are saved to your workspace.</p>
        <ul id="soul-files-list" class="groups-ul"></ul>
      </div>
      <div class="groups-main">
        <div id="soul-editor-card" class="groups-detail card">
          <h2 style="margin:0 0 0.75rem 0; font-size:1rem;" id="soul-editor-title">Select a file</h2>
          <p class="skill-meta" id="soul-editor-meta" style="margin:0 0 0.75rem 0;"></p>
          <div id="soul-editor-area" style="display:none;">
            <textarea id="soul-editor-textarea" class="skill-doc-inline skill-doc-textarea" spellcheck="false" style="display:block; width:100%; min-height:20rem; margin-bottom:0.75rem;"></textarea>
            <div><button id="soul-editor-save">Save</button><span id="soul-editor-saved" style="margin-left:0.75rem; color: var(--green); font-size:0.85rem; display:none;">Saved.</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="page-crons" class="page">
    <div class="card">
      <h2 style="margin:0 0 0.75rem 0; font-size:1rem;">Scheduled crons</h2>
      <div id="crons-list"></div>
    </div>
  </div>

  <div id="page-skills" class="page">
    <div class="card">
      <h2 style="margin:0 0 0.75rem 0; font-size:1rem;">Skills (main / one-on-one)</h2>
      <p class="skill-meta" style="margin:0 0 0.75rem 0;">Enable or disable skills for private chat; click a skill to view or edit its doc (SKILL.md).</p>
      <div id="skills-list"></div>
      <button id="skills-save" style="display:none;">Save enabled/disabled</button>
    </div>
  </div>

  <div id="page-groups" class="page">
    <div class="groups-layout">
      <div class="groups-sidebar card">
        <h2 style="margin:0 0 0.75rem 0; font-size:1rem;">Groups</h2>
        <p class="skill-meta" style="margin:0 0 0.5rem 0;">Click a group to edit its skills and LLM. Default settings are used by new groups.</p>
        <ul id="groups-list" class="groups-ul"></ul>
      </div>
      <div class="groups-main">
        <div id="groups-detail-content" class="groups-detail card">
          <h2 style="margin:0 0 0.75rem 0; font-size:1rem;" id="groups-detail-title">Select a group</h2>
          <p class="skill-meta" id="groups-detail-meta" style="margin:0 0 0.75rem 0;"></p>
          <div id="groups-detail-sub-nav" class="group-sub-nav" style="display:none;">
            <button type="button" data-group-tab="skills" class="active">Skills</button>
            <button type="button" data-group-tab="soul">Soul</button>
            <button type="button" data-group-tab="llm">LLM</button>
            <button type="button" data-group-tab="history">History</button>
          </div>
          <div id="groups-detail-skills" class="group-sub-panel active">
            <p class="skill-meta" style="margin:0 0 0.5rem 0;">Enable or disable skills; click a skill to view its doc (SKILL.md).</p>
            <div id="group-skills-list"></div>
            <button id="group-skills-save" style="display:none;">Save skills</button>
          </div>
          <div id="groups-detail-llm" class="group-sub-panel">
            <p class="skill-meta" style="margin:0 0 0.5rem 0;">Max tokens and models for this group. API keys from .env.</p>
            <div class="field" style="margin-top:0.5rem;">
              <label>Max tokens</label>
              <input type="number" id="group-llm-max-tokens" min="256" max="128000" step="256" value="2048">
            </div>
            <div id="group-llm-models" class="llm-models-grid"></div>
            <button id="group-llm-save">Save LLM</button>
            <span id="group-llm-saved" style="margin-left:0.75rem; color: var(--green); font-size:0.85rem; display:none;">Saved.</span>
          </div>
          <div id="groups-detail-history" class="group-sub-panel">
            <div id="history-stats" class="history-stats"></div>
            <div id="history-log-files" class="history-log-files"></div>
          </div>
          <div id="groups-detail-soul" class="group-sub-panel">
            <p class="skill-meta" style="margin:0 0 0.75rem 0;">Click a file to view or edit. Each group has its own copy — changes only affect this group.</p>
            <div id="group-soul-files" style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:1rem;"></div>
            <div id="group-soul-editor" style="display:none;">
              <div style="font-size:0.8rem; color:var(--muted); margin-bottom:0.4rem;" id="group-soul-file-label"></div>
              <textarea id="group-soul-textarea" spellcheck="false" style="width:100%; min-height:16rem; background:var(--bg); border:1px solid var(--border); color:var(--text); padding:0.75rem; border-radius:6px; font-family:inherit; font-size:0.9rem; resize:vertical; display:block; margin-bottom:0.75rem;"></textarea>
              <div>
                <button id="group-soul-save">Save</button>
                <span id="group-soul-saved" style="margin-left:0.75rem; color:var(--green); font-size:0.85rem; display:none;">Saved.</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="page-llm" class="page">
    <div class="card">
      <h2 style="margin:0 0 0.75rem 0; font-size:1rem;">LLM</h2>
      <p class="skill-meta" style="margin:0 0 1rem 0;">Edit below and save. API keys are stored in .env; use the env var name here (e.g. LLM_1_API_KEY).</p>
      <div class="field">
        <label>Max tokens</label>
        <input type="number" id="llm-max-tokens" min="256" max="128000" step="256" value="2048">
      </div>
      <div id="llm-models" class="llm-models-grid"></div>
      <button id="llm-save">Save LLM settings</button>
      <span id="llm-saved-msg" style="margin-left:0.75rem; color: var(--green); font-size:0.85rem; display:none;">Saved.</span>
    </div>
  </div>

  <div id="page-config" class="page">
    <div class="card">
      <h2 style="margin:0 0 0.75rem 0; font-size:1rem;">Config</h2>
      <p class="read-only-note">Final configuration (read-only). Written to config.json.</p>
      <pre id="full-config" class="config-json"></pre>
    </div>
  </div>

  <script>
    const API = '';
    var validPages = ['chat', 'status', 'crons', 'skills', 'groups', 'llm', 'config', 'soul'];
    function setPage(name, soulFileId) {
      if (!name || !validPages.includes(name)) name = 'chat';
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
      var page = document.getElementById('page-' + name);
      var link = document.querySelector('nav a[data-page="' + name + '"]');
      if (page) page.classList.add('active');
      if (link) link.classList.add('active');
      if (name === 'crons') fetchCrons();
      if (name === 'skills') fetchSkills();
      if (name === 'groups') fetchGroups();
      if (name === 'llm') renderLlmForm();
      if (name === 'config') fetchConfig();
      if (name === 'soul') {
        fetchSoulFiles().then(function () {
          if (soulFileId) selectSoulFile(soulFileId);
        });
      }
    }
    function parseHash() {
      var raw = (location.hash || '#chat').slice(1) || 'chat';
      var slash = raw.indexOf('/');
      var name = slash >= 0 ? raw.slice(0, slash) : raw;
      var soulFile = slash >= 0 ? raw.slice(slash + 1) : null;
      return { name: name, soulFile: soulFile };
    }
    document.querySelectorAll('nav a[data-page]').forEach(function (a) {
      a.addEventListener('click', function (e) {
        e.preventDefault();
        var page = a.dataset.page;
        location.hash = page === 'soul' ? '#soul' : '#' + page;
      });
    });
    window.addEventListener('hashchange', function () {
      var p = parseHash();
      setPage(p.name, p.soulFile);
    });

    async function fetchStatus() {
      const dot = document.getElementById('status-dot');
      const text = document.getElementById('status-text');
      const urlEl = document.getElementById('dashboard-url');
      try {
        const statusRes = await fetch(API + '/api/status');
        const statusData = await statusRes.json();
        if (statusData.dashboardUrl) urlEl.textContent = statusData.dashboardUrl;
        if (statusData.daemonRunning) {
          dot.className = 'status-dot running';
          text.textContent = 'Daemon is running';
        } else {
          dot.className = 'status-dot stopped';
          text.textContent = 'Daemon is not running';
        }
      } catch (e) {
        dot.className = 'status-dot stopped';
        text.textContent = 'Daemon is not running';
        urlEl.textContent = '—';
      }
      function formatUptime(sec) {
        if (sec == null || typeof sec !== 'number' || sec < 0) return '—';
        const d = Math.floor(sec / 86400);
        const h = Math.floor((sec % 86400) / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        const parts = [];
        if (d > 0) parts.push(d + 'd');
        if (h > 0) parts.push(h + 'h');
        if (m > 0) parts.push(m + 'm');
        if (s > 0 || parts.length === 0) parts.push(s + 's');
        return parts.join(' ');
      }
      function setOverview(d) {
        document.getElementById('overview-uptime').textContent = d.daemonRunning && d.daemonUptimeSeconds != null ? formatUptime(d.daemonUptimeSeconds) : '—';
        document.getElementById('overview-crons').textContent = typeof d.cronCount === 'number' ? d.cronCount : '—';
        document.getElementById('overview-skills').textContent = typeof d.skillsEnabledCount === 'number' ? d.skillsEnabledCount : '—';
        document.getElementById('overview-group-skills').textContent = typeof d.groupSkillsEnabledCount === 'number' ? d.groupSkillsEnabledCount : '—';
        document.getElementById('overview-model').textContent = d.priorityModelLabel || '—';
        document.getElementById('overview-timezone').textContent = d.timezone || '—';
        document.getElementById('overview-time-format').textContent = d.timeFormat === '12' ? '12-hour' : d.timeFormat === '24' ? '24-hour' : (d.timeFormat || '—');
      }
      try {
        const overviewRes = await fetch(API + '/api/overview');
        if (overviewRes.ok) {
          const d = await overviewRes.json();
          setOverview(d);
          return;
        }
      } catch (_) {}
      try {
        const [cronsRes, skillsRes, groupSkillsRes, configRes] = await Promise.all([
          fetch(API + '/api/crons'),
          fetch(API + '/api/skills'),
          fetch(API + '/api/group/skills'),
          fetch(API + '/api/config')
        ]);
        const crons = cronsRes.ok ? await cronsRes.json() : {};
        const skills = skillsRes.ok ? await skillsRes.json() : {};
        const groupSkills = groupSkillsRes.ok ? await groupSkillsRes.json() : {};
        const config = configRes.ok ? await configRes.json() : {};
        const jobs = crons.jobs || [];
        const cronCount = jobs.filter(function (j) { return j.enabled !== false; }).length;
        const skillsEnabled = skills.enabled || [];
        const groupSkillsEnabled = groupSkills.enabled || [];
        const models = config.llm && Array.isArray(config.llm.models) ? config.llm.models : [];
        const priorityEntry = models.find(function (m) { return m.priority === true || m.priority === 1 || String(m.priority).toLowerCase() === 'true'; }) || models[0];
        const priorityModelLabel = priorityEntry ? (priorityEntry.model || priorityEntry.provider || '—') : '—';
        const def = config.agents && config.agents.defaults ? config.agents.defaults : {};
        const tz = def.userTimezone && String(def.userTimezone).trim() && String(def.userTimezone).toLowerCase() !== 'auto' ? def.userTimezone : (typeof Intl !== 'undefined' && Intl.DateTimeFormat && Intl.DateTimeFormat().resolvedOptions ? Intl.DateTimeFormat().resolvedOptions().timeZone : 'UTC');
        const fmt = def.timeFormat === '12' || def.timeFormat === '24' ? def.timeFormat : null;
        setOverview({
          daemonRunning: false,
          daemonUptimeSeconds: null,
          cronCount: cronCount,
          skillsEnabledCount: skillsEnabled.length,
          groupSkillsEnabledCount: groupSkillsEnabled.length,
          priorityModelLabel: priorityModelLabel,
          timezone: tz,
          timeFormat: fmt || '—'
        });
      } catch (_) {}
    }

    async function fetchCrons() {
      const r = await fetch(API + '/api/crons');
      const d = await r.json();
      const el = document.getElementById('crons-list');
      const jobs = d.jobs || [];
      if (jobs.length === 0) {
        el.innerHTML = '<p class="empty">No scheduled crons.</p>';
        return;
      }
      el.innerHTML = '<table><thead><tr><th>Name</th><th>Enabled</th><th>Schedule</th><th>Message</th></tr></thead><tbody>' +
        jobs.map(j => {
          const s = j.schedule || {};
          const sched = s.kind === 'cron' ? (s.expr || '') : (s.at || '');
          return '<tr><td>' + escapeHtml(j.name || j.id) + '</td><td><span class="badge ' + (j.enabled ? 'enabled' : 'disabled') + '">' + (j.enabled ? 'On' : 'Off') + '</span></td><td>' + escapeHtml(sched) + '</td><td>' + escapeHtml((j.message || '').slice(0, 60)) + (j.message && j.message.length > 60 ? '…' : '') + '</td></tr>';
        }).join('') + '</tbody></table>';
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    let skillsDirty = false;
    let currentEnabled = [];

    let currentSkillId = null;

    async function fetchSkills() {
      const r = await fetch(API + '/api/skills');
      const d = await r.json();
      currentEnabled = d.enabled || [];
      const list = d.skills || [];
      const el = document.getElementById('skills-list');
      el.innerHTML = list.map(s => {
        const checked = currentEnabled.includes(s.id) ? ' checked' : '';
        const desc = (s.description || '').trim();
        const descHtml = desc ? '<div class="skill-desc">' + escapeHtml(desc) + '</div>' : '';
        return '<div class="skill-item"><div class="skill-row" data-id="' + escapeHtml(s.id) + '"><div><span class="skill-id">' + escapeHtml(s.id) + '</span>' + descHtml + '</div><label onclick="event.stopPropagation()"><input type="checkbox" data-id="' + escapeHtml(s.id) + '"' + checked + '> Enabled</label></div>' +
          '<div class="skill-doc-inline" data-id="' + escapeHtml(s.id) + '"><h3>Doc: ' + escapeHtml(s.id) + '</h3><p class="skill-meta skill-doc-desc" style="margin:0 0 0.5rem 0;"></p><textarea class="skill-doc-textarea" spellcheck="false"></textarea><div style="margin-top:0.75rem;"><button class="skill-doc-save-btn">Save doc</button><span class="skill-doc-saved" style="margin-left:0.75rem; color: var(--green); font-size:0.85rem; display:none;">Saved.</span></div></div></div>';
      }).join('');
      el.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', () => { skillsDirty = true; document.getElementById('skills-save').style.display = 'block'; });
      });
      el.querySelectorAll('.skill-row').forEach(row => {
        row.addEventListener('click', (e) => { if (!e.target.closest('label')) openSkillDoc(row.dataset.id, row.closest('.skill-item')); });
      });
      el.querySelectorAll('.skill-doc-save-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const panel = btn.closest('.skill-doc-inline');
          const id = panel && panel.dataset.id;
          if (!id) return;
          const content = panel.querySelector('.skill-doc-textarea').value;
          const r = await fetch(API + '/api/skills/' + encodeURIComponent(id) + '/doc', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content }) });
          if (r.ok) {
            const savedEl = panel.querySelector('.skill-doc-saved');
            if (savedEl) { savedEl.style.display = 'inline'; setTimeout(() => { savedEl.style.display = 'none'; }, 2000); }
          }
        });
      });
      document.getElementById('skills-save').style.display = 'none';
      skillsDirty = false;
    }

    async function openSkillDoc(id, skillItem) {
      currentSkillId = id;
      const listEl = document.getElementById('skills-list');
      listEl.querySelectorAll('.skill-doc-inline').forEach(p => p.classList.remove('open'));
      const panel = skillItem ? skillItem.querySelector('.skill-doc-inline') : listEl.querySelector('.skill-doc-inline[data-id="' + id + '"]');
      if (!panel) return;
      const r = await fetch(API + '/api/skills/' + encodeURIComponent(id) + '/doc');
      if (!r.ok) return;
      const d = await r.json();
      panel.querySelector('.skill-doc-desc').textContent = d.description || '';
      panel.querySelector('.skill-doc-textarea').value = d.content || '';
      panel.classList.add('open');
    }

    document.getElementById('skills-save').addEventListener('click', async () => {
      const boxes = document.querySelectorAll('#skills-list input[type="checkbox"]:checked');
      const enabled = Array.from(boxes).map(b => b.dataset.id);
      const r = await fetch(API + '/api/skills', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled }) });
      if (r.ok) { skillsDirty = false; document.getElementById('skills-save').style.display = 'none'; }
    });

    let groupSkillsDirty = false;
    let selectedGroupId = 'default';

    async function fetchGroups() {
      try {
        var ul = document.getElementById('groups-list');
        if (!ul) return;
        var oldHint = document.getElementById('groups-path-hint');
        if (oldHint) oldHint.remove();
        var r = await fetch(API + '/api/groups');
        var d = await r.json().catch(function () { return {}; });
        var groups = Array.isArray(d.groups) ? d.groups : [];
        if (d.error) console.error('[groups]', d.error);
        ul.innerHTML =
          '<li class="' + (selectedGroupId === 'default' ? 'selected' : '') + '"><button type="button" class="link" data-id="default">Default settings</button></li>' +
          groups.map(function (g) {
            return '<li class="' + (selectedGroupId === (g && g.id) ? 'selected' : '') + '"><button type="button" class="link" data-id="' + escapeHtml(String((g && g.id) || '')) + '">' + escapeHtml(String((g && g.label) || (g && g.id) || '')) + '</button></li>';
          }).join('');
        if (groups.length === 0 && (d._path || d.error) && ul.parentNode) {
          var hint = document.createElement('p');
          hint.id = 'groups-path-hint';
          hint.className = 'skill-meta';
          hint.style.marginTop = '0.5rem';
          hint.textContent = d.error ? ('Error: ' + d.error + (d._path ? ' (path: ' + d._path + ')' : '')) : ('No groups yet. Server reading: ' + (d._path || ''));
          ul.parentNode.insertBefore(hint, ul.nextSibling);
        }
        ul.querySelectorAll('button.link').forEach(function (btn) {
          btn.addEventListener('click', function () { selectGroup(btn.getAttribute('data-id')); });
        });
        selectGroup(selectedGroupId);
      } catch (e) {
        console.error('[groups]', e);
        var ul = document.getElementById('groups-list');
        if (ul) ul.innerHTML = '<li><button type="button" class="link" data-id="default">Default settings</button></li><li class="skill-meta">Error loading groups.</li>';
      }
    }

    var selectedGroupTab = 'skills';
    function setGroupTab(tab) {
      selectedGroupTab = tab;
      document.querySelectorAll('#groups-detail-sub-nav button[data-group-tab]').forEach(function (b) {
        b.classList.toggle('active', b.getAttribute('data-group-tab') === tab);
      });
      document.querySelectorAll('#groups-detail-content .group-sub-panel').forEach(function (p) {
        p.classList.toggle('active',
          (p.id === 'groups-detail-skills' && tab === 'skills') ||
          (p.id === 'groups-detail-llm' && tab === 'llm') ||
          (p.id === 'groups-detail-history' && tab === 'history') ||
          (p.id === 'groups-detail-soul' && tab === 'soul')
        );
      });
      if (tab === 'history') loadGroupHistory(selectedGroupId);
      if (tab === 'soul') loadGroupSoul(selectedGroupId);
    }
    function selectGroup(id) {
      selectedGroupId = id;
      document.querySelectorAll('#groups-list li').forEach(function (li) {
        var btn = li.querySelector('button.link');
        li.classList.toggle('selected', btn && btn.getAttribute('data-id') === id);
      });
      var titleEl = document.getElementById('groups-detail-title');
      var metaEl = document.getElementById('groups-detail-meta');
      var subNavEl = document.getElementById('groups-detail-sub-nav');
      var skillsEl = document.getElementById('groups-detail-skills');
      var llmEl = document.getElementById('groups-detail-llm');
      var historyEl = document.getElementById('groups-detail-history');
      titleEl.textContent = id === 'default' ? 'Default group settings' : ('Group ' + id);
      subNavEl.style.display = id ? 'flex' : 'none';
      setGroupTab(selectedGroupTab);
      loadGroupSkills(id);
      loadGroupConfig(id);
      if (id !== 'default') {
        fetch(API + '/api/groups/' + encodeURIComponent(id))
          .then(function (r) { return r.ok ? r.json() : null; })
          .then(function (d) {
            if (d && d.chatLogPath) metaEl.textContent = 'Chat log: ' + d.chatLogPath;
            else metaEl.textContent = '';
          })
          .catch(function () { metaEl.textContent = ''; });
      } else {
        metaEl.textContent = 'Used as template for new groups. Stored in ~/.cowcode/group/.';
      }
    }
    function timeAgo(isoStr) {
      if (!isoStr) return '—';
      var d = new Date(isoStr);
      if (isNaN(d.getTime())) return '—';
      var sec = Math.floor((Date.now() - d.getTime()) / 1000);
      if (sec < 60) return sec + 's ago';
      if (sec < 3600) return Math.floor(sec / 60) + 'm ago';
      if (sec < 86400) return Math.floor(sec / 3600) + 'h ago';
      if (sec < 2592000) return Math.floor(sec / 86400) + 'd ago';
      if (sec < 31536000) return Math.floor(sec / 2592000) + 'mo ago';
      return Math.floor(sec / 31536000) + 'y ago';
    }
    async function loadGroupHistory(groupId) {
      var statsEl = document.getElementById('history-stats');
      var filesEl = document.getElementById('history-log-files');
      if (groupId === 'default') {
        statsEl.innerHTML = '<p class="skill-meta">Default settings have no chat log. Add the bot to a Telegram group and chat to see history here.</p>';
        filesEl.innerHTML = '';
        return;
      }
      try {
        var r = await fetch(API + '/api/groups/' + encodeURIComponent(groupId) + '/history');
        var d = await r.json();
        if (d.message) {
          statsEl.innerHTML = '<p class="skill-meta">' + escapeHtml(d.message) + '</p>';
          filesEl.innerHTML = '';
          return;
        }
        var first = d.firstActivity ? new Date(d.firstActivity).toLocaleString() : '—';
        var last = d.lastActivity ? new Date(d.lastActivity).toLocaleString() : '—';
        var ago = timeAgo(d.lastActivity);
        statsEl.innerHTML =
          '<div class="history-stat"><span class="label">First activity</span><br>' + escapeHtml(first) + '</div>' +
          '<div class="history-stat"><span class="label">Last activity</span><br>' + escapeHtml(last) + '</div>' +
          '<div class="history-stat"><span class="label">How long ago</span><br>' + escapeHtml(ago) + '</div>' +
          '<div class="history-stat"><span class="label">Total exchanges</span><br>' + (typeof d.totalExchanges === 'number' ? d.totalExchanges : '—') + '</div>';
        if (!d.logFiles || d.logFiles.length === 0) {
          filesEl.innerHTML = '<p class="skill-meta">No log files yet.</p>';
        } else {
          filesEl.innerHTML = '<table><thead><tr><th>File</th><th>Last modified</th><th>Exchanges</th></tr></thead><tbody>' +
            d.logFiles.map(function (f) {
              var mtime = f.mtimeISO ? new Date(f.mtimeISO).toLocaleString() : '—';
              var count = f.exchanges != null ? f.exchanges : (f.error ? '—' : '—');
              return '<tr><td>' + escapeHtml(f.name) + '</td><td>' + escapeHtml(mtime) + '</td><td>' + escapeHtml(String(count)) + '</td></tr>';
            }).join('') + '</tbody></table>';
        }
      } catch (e) {
        statsEl.innerHTML = '<p class="skill-meta">Error loading history.</p>';
        filesEl.innerHTML = '';
      }
    }

    async function loadGroupSkills(groupId) {
      var r = await fetch(API + '/api/groups/' + encodeURIComponent(groupId) + '/skills');
      var d = await r.json();
      var enabled = d.enabled || [];
      var list = d.skills || [];
      var el = document.getElementById('group-skills-list');
      el.innerHTML = list.map(function (s) {
        var checked = enabled.includes(s.id) ? ' checked' : '';
        var desc = (s.description || '').trim();
        var descHtml = desc ? '<div class="skill-desc">' + escapeHtml(desc) + '</div>' : '';
        return '<div class="skill-item"><div class="skill-row" data-id="' + escapeHtml(s.id) + '"><div><span class="skill-id">' + escapeHtml(s.id) + '</span>' + descHtml + '</div><label onclick="event.stopPropagation()"><input type="checkbox" data-id="' + escapeHtml(s.id) + '"' + checked + '> Enabled</label></div><div class="skill-doc-inline" data-id="' + escapeHtml(s.id) + '"><h3>Doc: ' + escapeHtml(s.id) + '</h3><p class="skill-meta skill-doc-desc" style="margin:0 0 0.5rem 0;"></p><textarea class="skill-doc-textarea" spellcheck="false"></textarea><div style="margin-top:0.75rem;"><button type="button" class="skill-doc-save-btn">Save doc</button><span class="skill-doc-saved" style="margin-left:0.75rem; color: var(--green); font-size:0.85rem; display:none;">Saved.</span></div></div></div>';
      }).join('');
      el.querySelectorAll('input[type="checkbox"]').forEach(function (cb) {
        cb.addEventListener('change', function () { groupSkillsDirty = true; document.getElementById('group-skills-save').style.display = 'block'; });
      });
      el.querySelectorAll('.skill-row').forEach(function (row) {
        row.addEventListener('click', function (e) { if (!e.target.closest('label')) openGroupSkillDoc(row.getAttribute('data-id'), row.closest('.skill-item')); });
      });
      el.querySelectorAll('.skill-doc-save-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var panel = btn.closest('.skill-doc-inline');
          var skillId = panel && panel.getAttribute('data-id');
          if (!skillId) return;
          var content = panel.querySelector('.skill-doc-textarea').value;
          fetch(API + '/api/skills/' + encodeURIComponent(skillId) + '/doc', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: content }) }).then(function (r) {
            if (r.ok) { var saved = panel.querySelector('.skill-doc-saved'); if (saved) { saved.style.display = 'inline'; setTimeout(function () { saved.style.display = 'none'; }, 2000); } }
          });
        });
      });
      document.getElementById('group-skills-save').style.display = 'none';
      groupSkillsDirty = false;
    }

    async function openGroupSkillDoc(id, skillItem) {
      var listEl = document.getElementById('group-skills-list');
      listEl.querySelectorAll('.skill-doc-inline').forEach(function (p) { p.classList.remove('open'); });
      var panel = skillItem ? skillItem.querySelector('.skill-doc-inline') : listEl.querySelector('.skill-doc-inline[data-id="' + id + '"]');
      if (!panel) return;
      var r = await fetch(API + '/api/skills/' + encodeURIComponent(id) + '/doc');
      if (!r.ok) return;
      var d = await r.json();
      panel.querySelector('.skill-doc-desc').textContent = d.description || '';
      panel.querySelector('.skill-doc-textarea').value = d.content || '';
      panel.classList.add('open');
    }

    document.getElementById('group-skills-save').addEventListener('click', async function () {
      var boxes = document.querySelectorAll('#group-skills-list input[type="checkbox"]:checked');
      var enabled = Array.from(boxes).map(function (b) { return b.getAttribute('data-id'); });
      var r = await fetch(API + '/api/groups/' + encodeURIComponent(selectedGroupId) + '/skills', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled: enabled }) });
      if (r.ok) { groupSkillsDirty = false; document.getElementById('group-skills-save').style.display = 'none'; }
    });
    document.querySelectorAll('#groups-detail-sub-nav button[data-group-tab]').forEach(function (btn) {
      btn.addEventListener('click', function () { setGroupTab(btn.getAttribute('data-group-tab')); });
    });

    async function loadGroupConfig(groupId) {
      var r = await fetch(API + '/api/groups/' + encodeURIComponent(groupId) + '/config');
      var config = await r.json();
      var llm = config.llm || {};
      var maxTokens = Number(llm.maxTokens) || 2048;
      var models = Array.isArray(llm.models) ? llm.models : [];
      document.getElementById('group-llm-max-tokens').value = maxTokens;
      var container = document.getElementById('group-llm-models');
      container.innerHTML = models.map(function (m, i) {
        var baseUrl = (m.baseUrl || '').trim();
        var apiKey = (m.apiKey || '').trim();
        var priority = m.priority === true || m.priority === 1 || String(m.priority).toLowerCase() === 'true';
        return '<div class="llm-model" data-i="' + i + '"><h3>Model ' + (i + 1) + ': ' + escapeHtml(m.provider || '') + '</h3><div class="form-row"><div class="field"><label>Provider</label><input type="text" data-f="provider" value="' + escapeHtml(m.provider || '') + '"></div></div><div class="form-row"><div class="field"><label>Model name</label><input type="text" data-f="model" value="' + escapeHtml(m.model || '') + '"></div></div><div class="form-row"><div class="field"><label>Base URL (optional)</label><input type="text" data-f="baseUrl" value="' + escapeHtml(baseUrl) + '"></div></div><div class="form-row"><div class="field"><label>API key env var</label><input type="text" data-f="apiKey" value="' + escapeHtml(apiKey) + '"></div></div><div class="form-row"><label><input type="checkbox" data-f="priority" ' + (priority ? 'checked' : '') + '> Priority</label></div></div>';
      }).join('');
      if (models.length === 0) { container.innerHTML = '<p class="empty">No models. Add in main Config or paste JSON.</p>'; }
    }

    document.getElementById('group-llm-save').addEventListener('click', async function () {
      var maxTokens = Number(document.getElementById('group-llm-max-tokens').value) || 2048;
      var cards = document.querySelectorAll('#group-llm-models .llm-model');
      var models = Array.from(cards).map(function (card) {
        var provider = (card.querySelector('[data-f="provider"]').value || '').trim();
        var model = (card.querySelector('[data-f="model"]').value || '').trim();
        var baseUrl = (card.querySelector('[data-f="baseUrl"]').value || '').trim();
        var apiKey = (card.querySelector('[data-f="apiKey"]').value || '').trim();
        var priority = card.querySelector('[data-f="priority"]').checked;
        var o = { provider: provider || 'openai', model: model || 'gpt-4o', apiKey: apiKey || 'LLM_1_API_KEY' };
        if (baseUrl) o.baseUrl = baseUrl;
        if (priority) o.priority = true;
        return o;
      });
      var r = await fetch(API + '/api/groups/' + encodeURIComponent(selectedGroupId) + '/config', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ llm: { maxTokens: maxTokens, models: models } }) });
      if (r.ok) { document.getElementById('group-llm-saved').style.display = 'inline'; setTimeout(function () { document.getElementById('group-llm-saved').style.display = 'none'; }, 2000); }
    });

    var selectedGroupSoulFileId = null;

    async function loadGroupSoul(groupId) {
      var filesEl = document.getElementById('group-soul-files');
      var editorEl = document.getElementById('group-soul-editor');
      filesEl.innerHTML = '';
      editorEl.style.display = 'none';
      selectedGroupSoulFileId = null;
      try {
        var r = await fetch(API + '/api/groups/' + encodeURIComponent(groupId) + '/md');
        var d = await r.json();
        var files = d.files || [];
        filesEl.innerHTML = files.map(function (f) {
          return '<button type="button" class="group-soul-file-btn" data-id="' + escapeHtml(f.id) + '" style="background:var(--card); border:1px solid var(--border); color:var(--muted); font:inherit; font-size:0.85rem; padding:0.35rem 0.75rem; border-radius:4px; cursor:pointer; margin-top:0;">' + escapeHtml(f.label) + '</button>';
        }).join('');
        filesEl.querySelectorAll('.group-soul-file-btn').forEach(function (btn) {
          btn.addEventListener('click', function () { selectGroupSoulFile(groupId, btn.getAttribute('data-id')); });
        });
        if (files.length > 0) selectGroupSoulFile(groupId, files[0].id);
      } catch (e) {
        filesEl.innerHTML = '<span class="skill-meta">Error loading files.</span>';
      }
    }

    async function selectGroupSoulFile(groupId, fileId) {
      selectedGroupSoulFileId = fileId;
      document.querySelectorAll('.group-soul-file-btn').forEach(function (btn) {
        var active = btn.getAttribute('data-id') === fileId;
        btn.style.color = active ? 'var(--accent)' : 'var(--muted)';
        btn.style.borderColor = active ? 'var(--accent)' : 'var(--border)';
      });
      document.getElementById('group-soul-file-label').textContent = 'File: ' + fileId + ' — saved to this group\'s config directory only.';
      document.getElementById('group-soul-editor').style.display = 'block';
      document.getElementById('group-soul-textarea').value = '';
      try {
        var r = await fetch(API + '/api/groups/' + encodeURIComponent(groupId) + '/md/' + encodeURIComponent(fileId));
        var d = await r.json();
        document.getElementById('group-soul-textarea').value = d.content || '';
      } catch (e) {
        document.getElementById('group-soul-textarea').value = '';
      }
    }

    document.getElementById('group-soul-save').addEventListener('click', async function () {
      if (!selectedGroupSoulFileId) return;
      var content = document.getElementById('group-soul-textarea').value;
      var r = await fetch(
        API + '/api/groups/' + encodeURIComponent(selectedGroupId) + '/md/' + encodeURIComponent(selectedGroupSoulFileId),
        { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: content }) }
      );
      if (r.ok) {
        var savedEl = document.getElementById('group-soul-saved');
        savedEl.style.display = 'inline';
        setTimeout(function () { savedEl.style.display = 'none'; }, 2000);
      }
    });

    async function fetchConfig() {
      const r = await fetch(API + '/api/config');
      const d = await r.json();
      document.getElementById('full-config').textContent = JSON.stringify(d, null, 2);
    }

    var selectedSoulFileId = null;

    async function fetchSoulFiles() {
      try {
        const r = await fetch(API + '/api/workspace-md');
        const d = await r.json();
        const files = d.files || [];
        const ul = document.getElementById('soul-files-list');
        ul.innerHTML = files.map(function (f) {
          return '<li class="' + (selectedSoulFileId === f.id ? 'selected' : '') + '"><button type="button" class="link soul-file-btn" data-id="' + escapeHtml(f.id) + '">' + escapeHtml(f.label) + '</button></li>';
        }).join('');
        if (files.length === 0) ul.innerHTML = '<li class="empty">No workspace MD files.</li>';
        ul.querySelectorAll('.soul-file-btn').forEach(function (btn) {
          btn.addEventListener('click', function () { selectSoulFile(btn.getAttribute('data-id')); });
        });
      } catch (e) {
        console.error('[soul]', e);
        document.getElementById('soul-files-list').innerHTML = '<li class="skill-meta">Error loading files.</li>';
      }
    }

    async function selectSoulFile(id) {
      selectedSoulFileId = id;
      if (id && location.hash !== '#soul/' + id) location.hash = '#soul/' + id;
      document.querySelectorAll('#soul-files-list li').forEach(function (li) {
        var btn = li.querySelector('.soul-file-btn');
        li.classList.toggle('selected', btn && btn.getAttribute('data-id') === id);
      });
      var titleEl = document.getElementById('soul-editor-title');
      var metaEl = document.getElementById('soul-editor-meta');
      var areaEl = document.getElementById('soul-editor-area');
      var label = id;
      if (id === 'SOUL.md') label = 'Soul';
      else if (id === 'WhoAmI.md') label = 'Who am I';
      else if (id === 'MyHuman.md') label = 'My human';
      else if (id === 'MEMORY.md') label = 'Memory';
      titleEl.textContent = label;
      metaEl.textContent = 'File: ' + id;
      areaEl.style.display = 'block';
      try {
        var r = await fetch(API + '/api/workspace-md/' + encodeURIComponent(id));
        if (!r.ok) throw new Error('Failed to load');
        var d = await r.json();
        document.getElementById('soul-editor-textarea').value = d.content || '';
      } catch (e) {
        document.getElementById('soul-editor-textarea').value = '';
      }
    }

    document.getElementById('soul-editor-save').addEventListener('click', async function () {
      var id = selectedSoulFileId;
      if (!id) return;
      var content = document.getElementById('soul-editor-textarea').value;
      var r = await fetch(API + '/api/workspace-md/' + encodeURIComponent(id), { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: content }) });
      if (r.ok) {
        var savedEl = document.getElementById('soul-editor-saved');
        savedEl.style.display = 'inline';
        setTimeout(function () { savedEl.style.display = 'none'; }, 2000);
      }
    });

    async function renderLlmForm() {
      const r = await fetch(API + '/api/config');
      const d = await r.json();
      const llm = d.llm || {};
      const maxTokens = Number(llm.maxTokens) || 2048;
      const models = Array.isArray(llm.models) ? llm.models : [];
      document.getElementById('llm-max-tokens').value = maxTokens;
      const container = document.getElementById('llm-models');
      container.innerHTML = models.map((m, i) => {
        const baseUrl = (m.baseUrl || '').trim();
        const apiKey = (m.apiKey || '').trim();
        const priority = m.priority === true || m.priority === 1 || String(m.priority).toLowerCase() === 'true';
        return '<div class="llm-model" data-i="' + i + '">' +
          '<h3>Model ' + (i + 1) + ': ' + escapeHtml(m.provider || '') + '</h3>' +
          '<div class="form-row"><div class="field"><label>Provider</label><input type="text" data-f="provider" value="' + escapeHtml(m.provider || '') + '" placeholder="openai, lmstudio, anthropic, grok"></div></div>' +
          '<div class="form-row"><div class="field"><label>Model name</label><input type="text" data-f="model" value="' + escapeHtml(m.model || '') + '" placeholder="gpt-4o, local"></div></div>' +
          '<div class="form-row"><div class="field"><label>Base URL (optional, for local)</label><input type="text" data-f="baseUrl" value="' + escapeHtml(baseUrl) + '" placeholder="http://127.0.0.1:1234/v1"></div></div>' +
          '<div class="form-row"><div class="field"><label>API key env var</label><input type="text" data-f="apiKey" value="' + escapeHtml(apiKey) + '" placeholder="LLM_1_API_KEY"></div></div>' +
          '<div class="form-row"><label><input type="checkbox" data-f="priority" ' + (priority ? 'checked' : '') + '> Priority (use first)</label></div>' +
          '</div>';
      }).join('');
      if (models.length === 0) { container.className = ''; container.innerHTML = '<p class="empty">No models in config. Add entries in Config (read-only) or via setup.</p>'; } else { container.className = 'llm-models-grid'; }
    }

    document.getElementById('llm-save').addEventListener('click', async () => {
      const maxTokens = Number(document.getElementById('llm-max-tokens').value) || 2048;
      const modelCards = document.querySelectorAll('#llm-models .llm-model');
      const models = Array.from(modelCards).map(card => {
        const provider = (card.querySelector('[data-f="provider"]').value || '').trim();
        const model = (card.querySelector('[data-f="model"]').value || '').trim();
        const baseUrl = (card.querySelector('[data-f="baseUrl"]').value || '').trim();
        const apiKey = (card.querySelector('[data-f="apiKey"]').value || '').trim();
        const priority = card.querySelector('[data-f="priority"]').checked;
        const o = { provider: provider || 'openai', model: model || 'gpt-4o', apiKey: apiKey || 'LLM_1_API_KEY' };
        if (baseUrl) o.baseUrl = baseUrl;
        if (priority) o.priority = true;
        return o;
      });
      const r = await fetch(API + '/api/config', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ llm: { maxTokens, models } }) });
      if (r.ok) {
        document.getElementById('llm-saved-msg').style.display = 'inline';
        setTimeout(() => { document.getElementById('llm-saved-msg').style.display = 'none'; }, 2000);
      }
    });

    var chatMessages = [];
    var chatLoading = false;

    function renderChatMessages() {
      var el = document.getElementById('chat-messages');
      if (!el) return;
      el.innerHTML = chatMessages.map(function (m) {
        var c = escapeHtml(m.content || '');
        return '<div class="chat-msg ' + (m.role === 'user' ? 'user' : 'assistant') + '">' + c + '</div>';
      }).join('');
      if (chatLoading) {
        el.innerHTML += '<div class="chat-msg loading">Thinking…</div>';
      }
      el.scrollTop = el.scrollHeight;
    }

    function chatHistoryForApi() {
      return chatMessages.slice(-20).map(function (m) { return { role: m.role, content: m.content }; });
    }

    async function sendChatMessage() {
      var input = document.getElementById('chat-input');
      if (!input) return;
      var text = (input.value || '').trim();
      if (!text || chatLoading) return;
      chatMessages.push({ role: 'user', content: text });
      input.value = '';
      chatLoading = true;
      renderChatMessages();
      try {
        var r = await fetch(API + '/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, history: chatHistoryForApi().slice(0, -1) })
        });
        var d = await r.json().catch(function () { return {}; });
        if (!r.ok) {
          chatMessages.push({ role: 'assistant', content: 'Error: ' + (d.error || r.status) });
        } else {
          chatMessages.push({ role: 'assistant', content: (d.reply || '').trim() || '(No reply)' });
        }
      } catch (e) {
        chatMessages.push({ role: 'assistant', content: 'Error: ' + (e.message || 'Network error') });
      }
      chatLoading = false;
      renderChatMessages();
    }

    document.getElementById('chat-send').addEventListener('click', sendChatMessage);
    document.getElementById('chat-input').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); }
    });

    fetchStatus();
    setInterval(fetchStatus, 8000);
    (function () {
      var p = parseHash();
      setPage(p.name, p.soulFile);
    })();
  </script>
</body>
</html>
